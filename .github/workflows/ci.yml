name: CI
on:
  pull_request:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps
        run: |
          pip install .[dev]
      - name: Start MinIO
        run: |
          docker run -d \
            --name minio \
            -p 9000:9000 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio server /data
      - name: Wait for MinIO
        run: |
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:9000/minio/health/live >/dev/null; then
              exit 0
            fi
            sleep 1
          done
          echo "MinIO did not become healthy in time"
          exit 1
      - name: Create MinIO test bucket
        env:
          AWS_ACCESS_KEY_ID: minioadmin
          AWS_SECRET_ACCESS_KEY: minioadmin
          AWS_DEFAULT_REGION: us-east-1
        run: |
          python - <<'PY'
          import boto3

          s3 = boto3.client("s3", endpoint_url="http://127.0.0.1:9000")
          bucket = "ontologia-ci"
          existing = {b["Name"] for b in s3.list_buckets().get("Buckets", [])}
          if bucket not in existing:
              s3.create_bucket(Bucket=bucket)
          PY
      - name: Ruff format & lint
        run: |
          ruff format .
          ruff check . --fix
      - name: Pyright
        run: |
          pyright
      - name: Zero type:ignore policy
        run: |
          count=$(grep -r "# type: ignore" ontologia/ --include="*.py" | wc -l)
          if [ "$count" -gt 0 ]; then
            echo "❌ ERROR: Found $count type: ignore comments in ontologia/"
            echo ""
            echo "Goldex enforces ZERO type: ignore comments in production code."
            echo "See TECHSTACK.md type safety section for proper approaches."
            echo ""
            echo "Found suppressions:"
            grep -r "# type: ignore" ontologia/ --include="*.py" -n
            exit 1
          fi
          echo "✅ Zero type: ignore comments - policy enforced!"
      - name: Tests
        env:
          ONTOLOGIA_S3_TEST: "1"
          ONTOLOGIA_S3_BUCKET: ontologia-ci
          ONTOLOGIA_S3_ENDPOINT: http://127.0.0.1:9000
          ONTOLOGIA_S3_REGION: us-east-1
          AWS_ACCESS_KEY_ID: minioadmin
          AWS_SECRET_ACCESS_KEY: minioadmin
          AWS_DEFAULT_REGION: us-east-1
        run: |
          pytest -v
